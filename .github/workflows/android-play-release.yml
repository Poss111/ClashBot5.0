name: Publish Android to Google Play

concurrency:
  group: android-release-${{ github.ref }}
  cancel-in-progress: true

on:
  release:
    types: [published]

permissions:
  contents: read

env:
  FLUTTER_VERSION: "3.38.5"
  JAVA_VERSION: "17"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_DEBUG_KEYSTORE_PATH: debug-keystore.jks
  ANDROID_RELEASE_KEYSTORE_PATH: release-keystore.jks
  PACKAGE_NAME: com.poss.clash.debug
  ANDROID_VERSION: "34"

jobs:
  play-publish:
    name: Build & Upload to Play
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
          cache-dependency-path: |
            frontend/android/*.gradle*
            frontend/android/**/gradle-wrapper.properties

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.9.1
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache/hosted
          key: ${{ runner.os }}-pub-${{ hashFiles('frontend/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          components: |
            platform-tools
            platforms;android-${{ env.ANDROID_VERSION }}
            build-tools;${{ env.ANDROID_VERSION }}.0.0

      - name: Provision keystores
        env:
          DEBUG_KEYSTORE_B64: ${{ secrets.DEBUG_KEYSTORE_B64 }}
          DEBUG_KEYSTORE_PASSWORD: ${{ secrets.DEBUG_KEYSTORE_PASSWORD }}
          DEBUG_KEY_PASSWORD: ${{ secrets.DEBUG_KEY_PASSWORD }}
          DEBUG_KEY_ALIAS: ${{ secrets.DEBUG_KEY_ALIAS }}
          RELEASE_KEYSTORE_B64: ${{ secrets.RELEASE_KEYSTORE_B64 }}
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
        run: |
          set -euo pipefail
          echo "$DEBUG_KEYSTORE_B64" | base64 -d > "android/app/$ANDROID_DEBUG_KEYSTORE_PATH"
          echo "$RELEASE_KEYSTORE_B64" | base64 -d > "android/app/$ANDROID_RELEASE_KEYSTORE_PATH"

          cat > android/debug-key.properties <<EOF
          storePassword=${DEBUG_KEYSTORE_PASSWORD}
          keyPassword=${DEBUG_KEY_PASSWORD}
          keyAlias=${DEBUG_KEY_ALIAS}
          storeFile=${ANDROID_DEBUG_KEYSTORE_PATH}
          EOF

          cat > android/key.properties <<EOF
          storePassword=${RELEASE_KEYSTORE_PASSWORD}
          keyPassword=${RELEASE_KEY_PASSWORD}
          keyAlias=${RELEASE_KEY_ALIAS}
          storeFile=${ANDROID_RELEASE_KEYSTORE_PATH}
          EOF

      - name: Flutter pub get
        run: flutter pub get

      - name: Build app bundle (release)
        run: |
          ./scripts/build_release.sh --android-only \
            --env prod \
            --cf-origin "${{ secrets.BACKEND_URL }}" \
            --cf-ws-origin "${{ secrets.WS_BACKEND_URL }}" \
            --build-name "${{ github.event.release.name || github.ref_name }}" \
            --build-number "${{ github.run_number }}"

      - name: Verify AAB exists
        run: |
          if [ ! -f build/app/outputs/bundle/release/app-release.aab ]; then
            echo "app-release.aab not found"
            exit 1
          fi

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Upload to Google Play (internal track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.PACKAGE_NAME }}
          releaseFiles: frontend/build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          releaseName: ${{ github.event.release.name || github.ref_name }}
          whatsNewDirectory: frontend/whats_new/


