name: Flutter build and screenshots

on:
  push:
    branches: ["main"]
    paths:
      - "frontend/**"
  workflow_dispatch:
    inputs:
      run-screenshots:
        description: "Run screenshot capture job"
        type: boolean
        default: true

permissions:
  contents: read

concurrency:
  group: "flutter-screens-${{ github.ref }}"
  cancel-in-progress: true

env:
  FLUTTER_VERSION: "3.27.0"
  JAVA_VERSION: "17"
  ANDROID_DEBUG_KEYSTORE_PATH: debug-keystore.jks
  ANDROID_RELEASE_KEYSTORE_PATH: release-keystore.jks

jobs:
  build:
    name: Build Flutter app
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.9.1
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Provision Android keystores and properties
        env:
          DEBUG_KEYSTORE_B64: ${{ secrets.DEBUG_KEYSTORE_B64 }}
          DEBUG_KEYSTORE_PASSWORD: ${{ secrets.DEBUG_KEYSTORE_PASSWORD }}
          DEBUG_KEY_PASSWORD: ${{ secrets.DEBUG_KEY_PASSWORD }}
          DEBUG_KEY_ALIAS: ${{ secrets.DEBUG_KEY_ALIAS }}
          RELEASE_KEYSTORE_B64: ${{ secrets.RELEASE_KEYSTORE_B64 }}
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
        run: |
          set -euo pipefail

          # Decode keystores
          echo "$DEBUG_KEYSTORE_B64" | base64 -d > "android/app/$ANDROID_DEBUG_KEYSTORE_PATH"
          echo "$RELEASE_KEYSTORE_B64" | base64 -d > "android/app/$ANDROID_RELEASE_KEYSTORE_PATH"

          cat > android/debug-key.properties <<EOF
          storePassword=${DEBUG_KEYSTORE_PASSWORD}
          keyPassword=${DEBUG_KEY_PASSWORD}
          keyAlias=${DEBUG_KEY_ALIAS}
          storeFile=${ANDROID_DEBUG_KEYSTORE_PATH}
          EOF

          cat > android/key.properties <<EOF
          storePassword=${RELEASE_KEYSTORE_PASSWORD}
          keyPassword=${RELEASE_KEY_PASSWORD}
          keyAlias=${RELEASE_KEY_ALIAS}
          storeFile=${ANDROID_RELEASE_KEYSTORE_PATH}
          EOF

      - name: Check if andoird keystore properties file exists
        run: |
          if [ ! -f android/debug-key.properties ]; then
            echo "Android debug key properties file does not exist"
            exit 1
          else
            echo "Android debug key properties file exists"
          fi
          if [ ! -f android/key.properties ]; then
            echo "Android release key properties file does not exist"
            exit 1
          else
            echo "Android release key properties file exists"
          fi

      - name: Pub get
        run: flutter pub get

      - name: Build APK (debug)
        run: flutter build apk --debug

      - name: Verify APK exists
        run: |
            if [ ! -f build/app/outputs/apk/debug/app-debug.apk ]; then
                echo "Android debug APK does not exist"
            exit 1
            else
                echo "Android debug APK exists"
            fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: app-debug-apk
          path: ${{ github.workspace }}/frontend/build/app/outputs/apk/debug/app-debug.apk
          if-no-files-found: error

  screenshots:
    name: Capture screenshots
    needs: build
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run-screenshots }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        device:
          - name: pixel-6-api-34
            api-level: 25
            target: google_apis
            arch: x86_64
            profile: pixel_6
          - name: pixel-4-api-33
            api-level: 25
            target: google_apis
            arch: x86_64
            profile: pixel_4
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.9.1
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Provision Android keystores and properties
        env:
          DEBUG_KEYSTORE_B64: ${{ secrets.DEBUG_KEYSTORE_B64 }}
          DEBUG_KEYSTORE_PASSWORD: ${{ secrets.DEBUG_KEYSTORE_PASSWORD }}
          DEBUG_KEY_PASSWORD: ${{ secrets.DEBUG_KEY_PASSWORD }}
          DEBUG_KEY_ALIAS: ${{ secrets.DEBUG_KEY_ALIAS }}
          RELEASE_KEYSTORE_B64: ${{ secrets.RELEASE_KEYSTORE_B64 }}
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
        run: |
          set -euo pipefail
          mkdir -p android/app

          echo "$DEBUG_KEYSTORE_B64" | base64 -d > "android/app/$ANDROID_DEBUG_KEYSTORE_PATH"
          echo "$RELEASE_KEYSTORE_B64" | base64 -d > "android/app/$ANDROID_RELEASE_KEYSTORE_PATH"

          cat > android/debug-key.properties <<EOF
          storePassword=${DEBUG_KEYSTORE_PASSWORD}
          keyPassword=${DEBUG_KEY_PASSWORD}
          keyAlias=${DEBUG_KEY_ALIAS}
          storeFile=${ANDROID_DEBUG_KEYSTORE_PATH}
          EOF

          cat > android/key.properties <<EOF
          storePassword=${RELEASE_KEYSTORE_PASSWORD}
          keyPassword=${RELEASE_KEY_PASSWORD}
          keyAlias=${RELEASE_KEY_ALIAS}
          storeFile=${ANDROID_RELEASE_KEYSTORE_PATH}
          EOF

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v5.0.0
        
      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.device.api-level }}

      - name: Prepare screenshots folder
        run: mkdir -p screenshots/${{ matrix.device.name }}

      - name: Launch emulator and run screenshot test
        uses: reactivecircus/android-emulator-runner@v2.35.0
        with:
          api-level: ${{ matrix.device.api-level }}
          emulator-boot-timeout: 120
          force-avd-creation: false
          disable-animations: true
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          script: ./gradlew connectedDebugAndroidTest
        #   script: |
        #     flutter pub get
        #     if [ ! -f integration_test/screenshot_test.dart ]; then
        #       echo "Add integration_test/screenshot_test.dart that writes images to ./screenshots"
        #       exit 1
        #     fi
        #     mkdir -p screenshots/${{ matrix.device.name }}
        #     flutter test integration_test/screenshot_test.dart \
        #       --device-id emulator-5554 \
        #       --dart-define=MOCK_AUTH=true \
        #       --dart-define=MOCK_API_ORIGIN=http://127.0.0.1:8080 \
        #       --dart-define=MOCK_WS_ORIGIN=ws://127.0.0.1:0 \
        #       --dart-define=SCREENSHOT_DIR=screenshots/${{ matrix.device.name }}
        #     find build -path "*screenshots*" -name "*.png" -print -exec cp {} screenshots/${{ matrix.device.name }}/ \;
        #     echo "Screenshots saved to screenshots/${{ matrix.device.name }}/"

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v6.0.0
        with:
          name: screenshots-${{ matrix.device.name }}
          path: ${{ github.workspace }}/frontend/screenshots/${{ matrix.device.name }}/
          if-no-files-found: error

